Parameters:
  Versioning:
    Default: 'Suspended'
    Type: String
    AllowedValues: [Enabled, Suspended]
  Owner:
    Type: String
    Description: 'Bucket Owner'

  Department:
    Type: String
    Description: 'Department Name'
    Default: 'IT'
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
        BucketName: 'new-encrypted-file'
        AccessControl: Private
        VersioningConfiguration:
          Status: !Ref Versioning
        BucketEncryption:
          ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'aws:kms'
              KMSMasterKeyID: !GetAtt 'Key.Arn'
              
   BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Bucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 's3:PutObject'
            Effect: Deny
            Resource: !Sub "arn:${AWS::Partition}:s3:::${Bucket}/*"
            Principal: '*'
            Condition:
              StringNotEquals:
                s3:x-amz-server-side-encryption: ''
                s3:x-amz-server-side-encryption-aws-kms-key-id: !GetAtt 'Key.Arn'

  Key:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: 'AWS::KMS::Key'
    Properties:
      EnableKeyRotation: 'true'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
          Action: 'kms:*'
          Resource: '*'
          
        Tags:
        - Key : Owner
          Value: !Ref Owner
        - Key : Department
          Value: !Ref Department
